## Микросервис для Службы международной доставки

[![Lang: EN](https://img.shields.io/badge/lang-EN-red)](README.md)
[![Python](https://img.shields.io/badge/python-3.12%2B-blue)](#инструкция-по-запуску)
[![License](https://img.shields.io/badge/license-MIT-green)](LICENSE)
[![Tests](https://img.shields.io/badge/tests-pytest-blue)](#тестирование)
[![Architecture](https://img.shields.io/badge/architecture-DDD%20&%20Clean%20architecture-orange)](#архитектура)

---

### Описание задачи:

- [EN](/TASK_EN.md)
- [RU](/TASK_RU.md)

---

### Содержание:

- [Описание](#описание)
- [Инструкция по запуску](#инструкция-по-запуску)
- [Тестирование](#тестирование)
- [Архитектура](#архитектура)
- [Лицензия](#лицензия)

---

### Описание

Микросервис для регистрации и расчета стоимости международных посылок.  
Реализован по принципам **Domain-Driven Design (DDD)** и **Чистой архитектуры** с использованием технологий:

- FastAPI и Pydantic — для организации REST API и валидации данных
- RabbitMQ — для асинхронной регистрации посылок с расчётом стоимости
- Redis — для кэширования курса доллара к рублю
- MySQL — база данных
- Swagger (OpenAPI) — для автогенерации документации
- Docker и docker-compose — для развёртывания и управления зависимостями

##### REST API:

- `POST /parcels`
  Регистрация новой посылки.
  Входные данные: JSON с названием, весом, типом и стоимостью содержимого.
  Посылка отправляется в очередь RabbitMQ, где воркер рассчитывает стоимость доставки и сохраняет данные в БД.

- `GET /parcels/types`
  Получение списка доступных типов посылок: одежда, электроника, разное.
  Данные берутся из отдельной таблицы в БД.

- `GET /parcels`
  Получение списка всех посылок текущего пользователя (хранится в cookie).
  Поддерживает:
  - пагинацию: `limit`, `offset`
  - фильтрацию по типу: `type_id`
  - фильтрацию по факту наличия стоимости: `has_price=true|false`

- `GET /parcels/{id}`
  Получение информации о конкретной посылке.
  Включает название, вес, тип, стоимость содержимого и рассчитанную стоимость доставки.

---

### Инструкция по запуску

Клонируйте репозиторий:

```bash
git clone https://github.com/artemy-sh/delivery-service.git
cd delivery-service
```

Создайте файл окружения на основе примера:

```bash
cp .env.example .env
```


#### 1. Запуск через `docker-compose`


```bash
docker-compose up --build
```

После сборки и запуска сервисов FastAPI будет доступен по адресу:

```
http://localhost:8000
```

Swagger-документация:

```
http://localhost:8000/docs
```

При запуске автоматически применяются миграции и инициализируются необходимые данные (в том числе типы посылок).

Для остановки и очистки контейнеров:

```bash
docker-compose down -v
```
#### 2. Запуск через `make`

Возможно использовать следующие команды `make`:


```bash
make up         # Запустить проект со сборкой (docker-compose up --build)
make down       # Остановить все сервисы (docker-compose down)
make run        # Запустить в фоне (docker-compose up -d)
make rebuild    # Пересобрать и перезапустить проект
make scale      # Запустить несколько воркеров: WORKERS=3 make scale
make migrate    # Применить миграции вручную через Alembic
make nuke       # Полная остановка и удаление всех данных (-v --remove-orphans)

make install    # Установить зависимости через Poetry
make mypy       # Проверка типов через mypy
make ruff       # Линтер ruff
```

#### 3. Локальный запуск без Docker

Системные зависимости:

* Python 3.12+
* MySQL
* Redis
* RabbitMQ


#### Установка зависимостей

```bash
poetry install
```

Создайте файл окружения:

Настройте переменные окружения в `.env` под локальную систему: хосты и порты сервисов MySQL, Redis, RabbitMQ.

---

#### Применение миграций

Перед запуском проекта необходимо создать таблицы в БД:

```bash
alembic upgrade head
```

Или через Makefile:

```bash
make migrations
```

---

#### Запуск приложения

Для локального запуска необходимо указать переменную окружения `PYTHONPATH=src`.

---

#### Запуск FastAPI-приложения

```bash
PYTHONPATH=src python3 src/main.py
```

Приложение будет доступно по адресу:
`http://localhost:8000`
Документация Swagger:
`http://localhost:8000/docs`


#### Запуск воркера RabbitMQ

```bash
PYTHONPATH=src python3 src/worker.py
```

### Тестирование

Проект содержит модульные тесты, запускаемые через `pytest`.


#### Запуск тестов

```bash
pytest
```

Также можно запустить через `make`:

```bash
make test
```

---

### Архитектура

Проект реализован по принципам **Domain-Driven Design (DDD)** и **Чистой архитектуры**.
Все зависимости направлены внутрь — от внешних слоёв к бизнес-логике.

#### Структура проекта

```
src/
├── delivery_service/
│   ├── domain/     
│   ├── application/    
│   ├── infrastructure/  
│   ├── presentation/   
│   └── entrypoints/     
│── main.py           
└── worker.py         
```

#### Описание слоёв

* **domain**
  Ядро предметной области: сущности (`Parcel`, `ParcelType`), value-objects и интерфейсы. Также здесь базовая реализация расчета стоимости доставки.

* **application**
  Сценарии использования (use-cases): реализуют бизнес-логику, используют абстракции репозиториев и внешних сервисов.

* **infrastructure**
  Конкретные реализации внешних интерфейсов: брокеры сообщений, SQLAlchemy для работы с БД, внешние API для получения курса, логгеры и Redis для кэширования.

* **presentation**
  Интерфейс приложения: роуты FastAPI, схемы валидации, мапперы между DTO и сущностями, стандартизация ошибок.

* **entrypoints**
  Точки входа в приложение: FastAPI-приложение, запуск consumer RabbitMQ, CLI.


---

#### Особенности

- Архитектура проекта позволяет:

  * Заменить FastAPI на любой другой фреймворк, не затрагивая бизнес-логику
  * Использовать другую реализацию брокера сообщений вместо RabbitMQ
  * Подключить альтернативные источники курсов валют
  * Расширять и модифицировать поведение без изменения бизнес-логики

- Все зависимости инвертированы:

  * Use-cases работают через абстракции (интерфейсы), а не напрямую с инфраструктурой
  * Инфраструктура подключается только на внешнем уровне

---

### Контакты

- **Автор**: Артемий Шалыгин
- **Email**: [artemy.sh@gmail.com](mailto:artemy.sh@gmail.com)  
- **Telegram**: [@artemy_sh](https://t.me/artemy_sh)  

---

#### Отчёт об ошибках:

Если вы нашли баг или хотите предложить улучшение — создайте issue в репозитории.

---

#### Лицензия:

[MIT License](/LICENSE)